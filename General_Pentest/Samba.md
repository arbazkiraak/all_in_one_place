Samba

# FOR SMB and RPC stuff, use the IP in parameters, not the name you use in etc hosts to not having any trouble

## Checklist 

- Use nse scripts of nmap

- ```smbclient -L \\\\<ip>\\<share>```

- ```smbclient \\\\<ip>\\<share name>```
      
- ```enum4linux-ng```

- ```nullinux```

- ```nbtscan -r 192.168.11.0/24```

- ```smbmap -H 10.10.10.125 -u 'user'```

- ```nmblookup -A ip```

- ```smbclient -W '' //ip/ipc$ -U''%'' -c 'help'``` 

- ```rpcclient -W '' -U''%'' ip -c 'lsaquery'```

- ```smbclient -W '' //ip/ipc$ -U''%'' -c 'q' ```

- ```rpcclient -W '' -c querydispinfo -U''%'' ip``` 

- ```rpcclient -W '' -c enumdomusers -U ''%'' ip```


---

## smbclient :

- Download files : 
```
prompt off
recurse on
mget *
```

- execute command : ```smbclient ... -c 'cd C.Smith; get password.txt'```
- to don't have problems with space, add "" : ```-c 'cd C.Smith\"HQ Reporting"\; get "new password.txt"```
- alternate data streams (ads) : ```-c 'allinfo <file>'```

- If you have new user, re enumerate everything.



## PASSWORD_MUST_CHANGE

- ```smbpasswd -U \<user\> -r <ip>```


## crackmapexec :

- ```cme smb -L``` :print modules for smb protocol
- ```cme smb -h``` : print options available for the protocol
- Example : ``` cme smb -u pentest -p 'P3nT3st' -M uac 10.10.10.152```


- To connect with the hash :
```-H <Samhash(secondone)> -U <user>```
or ```-H <LMHASH:NTHASH> (the two hashes) -U user```

- Execute things on the remote host (Be careful ! when the result is too long, you have not the entire result)

```-x``` for cmd
```-X``` for cmd in powershell
example :
```sudo cme smb 10.10.10.152 -u Administrator -H d0f73603a4d96655430fdf02de4afaee -x 'powershell.exe -command "ps"'```


---

## Cmd when you have the right permissions : 

psexec Adminitrator@10.10.10.152 -hashes '<LMHASH:NTHASH>'


--- 

## Find version of Samba 

Script with ngrep :

```
#!/bin/sh
#Author: rewardone
#Description:
#Requires root or enough permissions to use tcpdump
#Will listen for the first 7 packets of a null login
#and grab the SMB Version
#Notes:
#Will sometimes not capture or will print multiple
#lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 0.5 && echo ""
```
``` ./smbver.sh <IP>```


---

## Wireshark and SMB in Windows

Windows SMB is more complex than just a version, but looking in wireshark will give a bunch of information about the  connection. We can filter on ntlmssp.ntlmv2_response to see NTLMv2 traffic, for example.

---

## Access to a file is difficult ?

Try to access to it in web browser

---









 